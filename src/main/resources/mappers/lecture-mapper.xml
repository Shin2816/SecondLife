<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<mapper namespace="lectureMapper">
	<resultMap id="lecture" type="com.green.SecondLife.lecture.vo.LectureVO">
        <id column="LECTURE_CODE"               property="lectureCode"/>
        <result column="LECTURE_EVENT_CODE"     property="lectureEventCode"/>
        <result column="LECTURE_TITLE"          property="lectureTitle"/>
        <result column="LECTURE_STUDENT"        property="lectureStudent"/>
        <result column="LECTURE_PERIOD"         property="lecturePeriod"/>
        <result column="LECTURE_PRICE"          property="lecturePrice"/>
        <result column="INSTRUCTOR_CODE"        property="instructorCode"/>
        <association property="instructorVO"    resultMap="instructorMapper.instructor"/>
        <association property="lectureEventVO"  resultMap="lectureEvent"/>
    </resultMap>
    <!-- 수강생 테이블 -->
    <resultMap id="student" type="com.green.SecondLife.lecture.vo.StudentVO">
        <id column="STUDENT_CODE"           property="studentCode"/>
        <result column="MEMBER_ID"          property="memberId"/>
        <result column="LECTURE_CODE"       property="lectureCode"/>
    </resultMap>
    <!-- 강좌 리뷰 테이블 -->
    <resultMap id="lectureReview" type="com.green.SecondLife.lecture.vo.LectureReviewVO">
        <id column="LECTURE_REVIEW_CODE"         property="lectureReviewCode"/>
        <result column="LECTURE_CODE"            property="lectureCode"/>
        <result column="INSTRUCTOR_CODE"         property="instructorCode"/>
        <result column="STUDENT_CODE"            property="studentCode"/>
        <result column="LECTURE_STAR_POINT"      property="lectureStarPoint"/>
        <result column="LECTURE_REVIEW_CONTENT"  property="lectureReviewContent"/>
        <result column="LECTURE_REVIEW_DATE"     property="lectureReviewDate"/>
    </resultMap>
    <!-- 강좌 종목 테이블 -->
    <resultMap id="lectureEvent" type="com.green.SecondLife.lecture.vo.LectureEventVO">
        <id column="LECTURE_EVENT_CODE"             property="lectureEventCode"/>
        <result column="LECTURE_EVENT_NAME"         property="lectureEventName"/>
        <result column="LECTURE_EVENT_CONTENT"      property="lectureEventContent"/>
        <association property="lectureEventImgVO"   resultMap="lectureEventImg"/>
    </resultMap>
    <!-- 강좌 종목 이미지 테이블 -->
    <resultMap id="lectureEventImg" type="com.green.SecondLife.lecture.vo.LectureEventImgVO">
        <id column="LECTURE_EVENT_IMG_CODE"                 property="lectureEventImgCode"/>
        <result column="LECTURE_EVENT_CODE"                 property="lectureEventCode"/>
        <result column="LECTURE_EVENT_ORIGIN_FILE_NAME"     property="lectureEventOriginFileName"/>
        <result column="LECTURE_EVENT_ATTACHED_FILE_NAME"   property="lectureEventAttachedFileName"/>
    </resultMap>
    <!-- 관리자용 다음 강좌 종목 코드 조회 쿼리 -->
    <select id="adminSelectNextLectureEventCode" resultType="String">
        SELECT 'LECTURE_EVENT_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(LECTURE_EVENT_CODE, 15))), 0) + 1, 3,'0')
        FROM LECTURE_EVENT
    </select>
    <!-- 관리자용 강좌 종목 생성 쿼리 -->
    <insert id="adminInsertLectureEvent">
        INSERT INTO LECTURE_EVENT (
            LECTURE_EVENT_CODE
            , LECTURE_EVENT_NAME
            , LECTURE_EVENT_CONTENT
        ) VALUES (
            #{lectureEventCode}
            , #{lectureEventName}
            , #{lectureEventContent}
        )
    </insert>
    <!-- 관리자용 강좌 종목 이미지 등록 쿼리 -->
    <insert id="adminInsertLectureEventImg">
        INSERT INTO LECTURE_EVENT_IMG (
            LECTURE_EVENT_IMG_CODE
            , LECTURE_EVENT_CODE
            , LECTURE_EVENT_ORIGIN_FILE_NAME
            , LECTURE_EVENT_ATTACHED_FILE_NAME
        ) VALUES (
            (SELECT 'LECTURE_EVENT_IMG_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(LECTURE_EVENT_IMG_CODE, 19))), 0) + 1, 3,'0')
            FROM LECTURE_EVENT_IMG)
            , #{lectureEventCode}
            , #{lectureEventImgVO.lectureEventOriginFileName}
            , #{lectureEventImgVO.lectureEventAttachedFileName}
        )
    </insert>
    <!-- 관리자용 + 강사 등록용 강좌 종목 리스트 조회 쿼리 -->
    <select id="adminSelectLectureEventListForInsertInstructor" resultMap="lectureEvent">
        SELECT LECTURE_EVENT_CODE
            , LECTURE_EVENT_NAME
        FROM LECTURE_EVENT
    </select>
    <!-- 관리자용 강좌 종목 리스트 조회 쿼리 -->
    <!-- LECTURE_EVENT + LECTURE_EVENT_IMG 조인 -->
    <select id="adminSelectLectureEventList" resultMap="lectureEvent">
        SELECT EVENT.LECTURE_EVENT_CODE
            , LECTURE_EVENT_NAME
            , LECTURE_EVENT_CONTENT
            , LECTURE_EVENT_ATTACHED_FILE_NAME
        FROM LECTURE_EVENT EVENT, LECTURE_EVENT_IMG IMG
        WHERE EVENT.LECTURE_EVENT_CODE = IMG.LECTURE_EVENT_CODE
    </select>
    <!-- 관리자용 강좌 종목 상세 조회 쿼리 -->
    <select id="adminSelectLectureEventDetail" resultMap="lectureEvent">
        SELECT EVENT.LECTURE_EVENT_CODE
            , LECTURE_EVENT_NAME
            , LECTURE_EVENT_CONTENT
            , LECTURE_EVENT_ATTACHED_FILE_NAME
        FROM LECTURE_EVENT EVENT, LECTURE_EVENT_IMG IMG
        WHERE EVENT.LECTURE_EVENT_CODE = IMG.LECTURE_EVENT_CODE
        AND EVENT.LECTURE_EVENT_CODE = #{lectureEventCode}
    </select>
    <!-- 관리자용 강좌 종목 이름 수정 페치 -->
    <update id="adminUpdateLectureEventName">
        UPDATE LECTURE_EVENT
        SET LECTURE_EVENT_NAME = #{lectureEventName}
        WHERE LECTURE_EVENT_CODE = #{lectureEventCode}
    </update>
    <!-- 관리자용 강좌 종목 내용 수정 페치 -->
    <update id="adminUpdateLectureEventContent">
        UPDATE LECTURE_EVENT
        SET LECTURE_EVENT_CONTENT = #{lectureEventContent}
        WHERE LECTURE_EVENT_CODE = #{lectureEventCode}
    </update>
    <!-- 관리자용 강좌 종목 정보 수정 쿼리 -->
    <update id="adminUpdateLectureEventInfo">
        UPDATE LECTURE_EVENT
        SET LECTURE_EVENT_NAME = #{lectureEventName}
            , LECTURE_EVENT_CONTENT = #{lectureEventContent}
        WHERE LECTURE_EVENT_CODE = #{lectureEventCode}
    </update>
    <!-- 관리자용 강좌 종목 삭제 쿼리 -->
    <delete id="adminDeleteLectureEvent">
        DELETE LECTURE_EVENT
        WHERE LECTURE_EVENT_CODE = #{lectureEventCode}
    </delete>
    <!-- 관리자용 강좌 리뷰 리스트 조회 쿼리 -->
    <select id="adminSelectLectureReviewList" resultMap="lectureReview">
        SELECT LECTURE_REVIEW_CODE
            , LECTURE_CODE
            , INSTRUCTOR_CODE
            , STUDENT_CODE
            , LECTURE_STAR_POINT
            , LECTURE_REVIEW_CONTENT
            , TO_CHAR (LECTURE_REVIEW_DATE, 'YYYY-MM-DD') LECTURE_REVIEW_DATE
        FROM LECTURE_REVIEW
    </select>
    <!-- 관리자용 수업 생성 쿼리 -->
    <insert id="adminInsertLecture">
        INSERT INTO LECTURE (
            LECTURE_CODE
            , LECTURE_EVENT_CODE
            , LECTURE_TITLE
            , LECTURE_STUDENT
            , LECTURE_PERIOD
            , LECTURE_PRICE
            , INSTRUCTOR_CODE
        ) VALUES (
            (SELECT 'LECTURE_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(LECTURE_CODE, 9))), 0) + 1, 3,'0')
            FROM LECTURE)
            , #{lectureEventCode}
            , #{lectureTitle}
            , #{lectureStudent}
            ,
            <foreach collection="lecturePeriods" item="period" separator="||'~'||">
                #{period}
            </foreach>
            , #{lecturePrice}
            , #{instructorCode}
        )
    </insert>
    <!-- 관리자용 수업 목록 조회 쿼리-->
    <select id="adminSelectLectureList" resultMap="lecture">
        SELECT LECTURE_CODE
        , L.LECTURE_EVENT_CODE
        , LECTURE_EVENT_NAME
        , LECTURE_TITLE
        , LECTURE_STUDENT
        , LECTURE_PERIOD
        , LECTURE_PRICE
        , L.INSTRUCTOR_CODE
        , INSTRUCTOR_NAME
        FROM LECTURE L, INSTRUCTOR I, LECTURE_EVENT E
        WHERE L.INSTRUCTOR_CODE = I.INSTRUCTOR_CODE
        <if test="instructorCode != null">
            AND I.INSTRUCTOR_CODE = #{instructorCode}
        </if>
    </select>
    <!-- 관리자용 수업 상세 조회 쿼리-->
    <select id="adminSelectLectureDetail" resultMap="lecture">
        SELECT LECTURE_CODE
            , L.LECTURE_EVENT_CODE
            , LECTURE_TITLE
            , LECTURE_STUDENT
            , LECTURE_PERIOD
            , LECTURE_PRICE
            , L.INSTRUCTOR_CODE
            , INSTRUCTOR_NAME
        FROM LECTURE L, INSTRUCTOR I
        WHERE LECTURE_CODE = #{lectureCode}
        AND L.INSTRUCTOR_CODE = I.INSTRUCTOR_CODE
    </select>

    <!-- 관리자용 수업 강사 수정 쿼리 -->
    <update id="adminUpdateLectureInstructor">
        UPDATE LECTURE
        SET INSTRUCTOR_CODE = #{instructorCode}
        WHERE LECTURE_CODE = #{lectureCode}
    </update>
    <!-- 관리자용 수업 기간 수정 쿼리 -->
    <update id="adminUpdateLecturePeriod">
        UPDATE LECTURE
        SET LECTURE_PERIOD = #{lecturePeriod}
        WHERE LECTURE_CODE = #{lectureCode}
    </update>
    <!-- 관리자용 수업 정원 수정 쿼리 -->
    <update id="adminUpdateLectureStudent">
        UPDATE LECTURE
        SET LECTURE_STUDENT = #{lectureStudent}
        WHERE LECTURE_CODE = #{lectureCode}
    </update>

    <!-- 관리자용 수업 삭제 쿼리 -->
    <delete id="adminDeleteLecture">
        DELETE LECTURE
        WHERE LECTURE_CODE = #{lectureCode}
    </delete>
    <!-- 강좌 목록 조회 쿼리 join -->
    <select id="selectLectureList" resultMap="lecture">
        SELECT L.LECTURE_CODE
            , LECTURE_TITLE
            , LECTURE_PERIOD
            , LECTURE_PRICE
            , I.INSTRUCTOR_CODE
            , INSTRUCTOR_NAME
            , E.LECTURE_EVENT_CODE
            , LECTURE_EVENT_NAME
        FROM LECTURE L, INSTRUCTOR I, LECTURE_EVENT E
        WHERE L.INSTRUCTOR_CODE = I.INSTRUCTOR_CODE
        AND L.LECTURE_EVENT_CODE = E.LECTURE_EVENT_CODE
        <if test="lectureEventCode != null">
            AND L.LECTURE_EVENT_CODE = #{lectureEventCode}
        </if>
    </select>
    <!-- 강좌 수강신청 -->
    <insert id="insertStudent">
        INSERT INTO STUDENT (
            STUDENT_CODE
            , MEMBER_ID
            , LECTURE_CODE
        ) VALUES (
            (SELECT 'STUDENT_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(STUDENT_CODE, 9))), 0) + 1, 3,'0')
            FROM STUDENT)
            , #{memberId}
            , #{lectureCode}
        )
    </insert>
    <!-- 수강생 목록 조회 -->
    <select id="selectStudentList" resultMap="student">
        SELECT STUDENT_CODE
            , MEMBER_ID
            , LECTURE_CODE
        FROM STUDENT
        WHERE LECTURE_CODE = #{lectureCode}
    </select>
    <!-- 리뷰 작성을 하려는 학생 정보 조회 -->
    <select id="selectTheStudent" resultMap="student">
        SELECT STUDENT_CODE
            , MEMBER_ID
            , LECTURE_CODE
        FROM STUDENT
        WHERE LECTURE_CODE = #{lectureCode}
        AND MEMBER_ID = #{memberId}
    </select>
    <!-- 수강생 삭제 기능 -->
    <delete id="deleteStudent">
        DELETE STUDENT
        WHERE STUDENT_CODE = #{studentCode}
    </delete>
    <!--메인페이지 강좌 목록-->
    <select id="selectMainLectureList" resultMap="lecture">
        SELECT ROWNUM
            , LECTURE_CODE
            , LECTURE_TITLE
            , LECTURE_EVENT_CODE
            , LECTURE_STUDENT
            , LECTURE_PERIOD
            , LECTURE_PRICE
        FROM (
            SELECT ROWNUM AS ROW_NUM
                , LECTURE_CODE
                , LECTURE_TITLE
                , LECTURE_EVENT_CODE
                , LECTURE_STUDENT
                , LECTURE_PERIOD
                , LECTURE_PRICE
            FROM (
                SELECT LECTURE_CODE
                , LECTURE_TITLE
                , LECTURE_EVENT_CODE
                , LECTURE_STUDENT
                , LECTURE_PERIOD
                , LECTURE_PRICE
                FROM LECTURE
                ORDER BY LECTURE_CODE DESC
            )
        )
        WHERE ROWNUM &lt;= 5
    </select>
    <!-- 강좌 리뷰 등록 기능 -->
    <insert id="insertLectureReview">
        INSERT INTO LECTURE_REVIEW (
            LECTURE_REVIEW_CODE
            , LECTURE_CODE
            , INSTRUCTOR_CODE
            , STUDENT_CODE
            , LECTURE_STAR_POINT
            , LECTURE_REVIEW_CONTENT
        ) VALUES (
            (SELECT #{lectureCode}||'_REVIEW_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(LECTURE_REVIEW_CODE, 20))), 0) + 1, 3,'0')
            FROM LECTURE_REVIEW)
            , #{lectureCode}
            , #{instructorCode}
            , #{studentCode}
            , #{lectureStarPoint}
            , #{lectureReviewContent}
        )
    </insert>
    <!-- 강좌 리뷰 목록 조회 -->
    <select id="selectLectureReviewList" resultMap="lectureReview">
        SELECT LECTURE_REVIEW_CODE
            , LECTURE_CODE
            , INSTRUCTOR_CODE
            , LECTURE_STAR_POINT
            , LECTURE_REVIEW_CONTENT
            , TO_CHAR (LECTURE_REVIEW_DATE, 'YYYY-MM-DD') LECTURE_REVIEW_DATE
        FROM LECTURE_REVIEW
        WHERE INSTRUCTOR_CODE = #{instructorCode}
    </select>

</mapper>































